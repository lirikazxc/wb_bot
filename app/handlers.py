import json

from aiogram import *
from aiogram.filters import *
from aiogram.types import *
from utils.wildberries_api import WildberriesAPI
from utils.config_manager import add_shop, delete_shop, list_shops
from utils.report_formatter import *
from aiogram.fsm.context import FSMContext
from datetime import datetime, timedelta
from aiogram import types, Bot


router = Router()


HELP_TEXT = """
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Telegram-–±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂ –Ω–∞ Wildberries! üìä

–í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º:

‚ûï  /addshop - –î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω üè™
‚ùå  /delshop - –£–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω üóëÔ∏è
üìã  /shops - –°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ üìà
üìä  /report - –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–¥–∞–∂–∞—Ö ü§ë
‚ùì  /help - –ü–æ–º–æ—â—å, –µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã üí¨

–ù–∞—á–Ω–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –≤–∞—à–∏—Ö –ø—Ä–æ–¥–∞–∂–∞—Ö –Ω–∞ Wildberries! üöÄ
"""

#/start#
@router.message(Command("start"))
async def send_welcome(message: Message):
    help_text = HELP_TEXT
    await message.answer(help_text)



#/help#
@router.message(Command("help"))
async def send_help(message: Message):
    help_text = HELP_TEXT
    await message.answer(help_text)



#/report#
@router.message(Command("report"))
async def report_command(message: Message, state: FSMContext):
    shops = list_shops()
    if not shops:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤.")
        return

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=shop["name"], callback_data=f"select_shop:{shop['name']}")]
        for shop in shops
    ])

    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –¥–ª—è –æ—Ç—á–µ—Ç–∞:", reply_markup=keyboard)


@router.callback_query(F.data.startswith("select_shop:"))
async def select_shop(call: CallbackQuery, state: FSMContext):
    shop_name = call.data.split(":")[1]
    await state.update_data(shop_name=shop_name)
    await call.answer()

    period_keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–°–µ–≥–æ–¥–Ω—è", callback_data="period_today")],
        [InlineKeyboardButton(text="–í—á–µ—Ä–∞", callback_data="period_yesterday")],
        [InlineKeyboardButton(text="–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π", callback_data="period_last_7_days")],
        [InlineKeyboardButton(text="–ö–∞—Å—Ç–æ–º–Ω—ã–π –ø–µ—Ä–∏–æ–¥", callback_data="period_custom")]
    ])

    await call.message.answer(f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –º–∞–≥–∞–∑–∏–Ω {shop_name}. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á–µ—Ç–∞:", reply_markup=period_keyboard)



@router.callback_query(F.data.startswith("report_sales"))
async def report_sales(call: CallbackQuery, state: FSMContext):
    await call.answer()
    await fetch_and_send_report(call, state, report_type="sales")

@router.callback_query(F.data.startswith("report_stocks"))
async def report_stocks(call: CallbackQuery, state: FSMContext):
    await call.answer()
    await fetch_and_send_report(call, state, report_type="stocks")

@router.callback_query(F.data.startswith("report_incomes"))
async def report_incomes(call: CallbackQuery, state: FSMContext):
    await call.answer()
    await fetch_and_send_report(call, state, report_type="incomes")

@router.callback_query(F.data.startswith("report_orders"))
async def report_orders(call: CallbackQuery, state: FSMContext):
    await call.answer()
    await fetch_and_send_report(call, state, report_type="orders")

@router.callback_query(F.data.startswith("report_reportDetailByPeriod"))
async def report_reportDetailByPeriod(call: CallbackQuery, state: FSMContext):
    await call.answer()
    await fetch_and_send_report(call, state, report_type="reportDetailByPeriod")

# @router.callback_query(F.data.startsWith("report_all"))
# async def report_all(call: CallbackQuery, state: FSMContext):
#     await call.answer()
#     await fetch_and_send_report(call, state, report_type="all")


@router.callback_query(F.data == "period_today")
async def period_today(call: CallbackQuery, state: FSMContext):
    current_time = datetime.now()

    start_date = current_time.replace(hour=0, minute=0, second=0, microsecond=0).strftime("%Y-%m-%d %H:%M:%S")
    end_date = (current_time - timedelta(hours=3)).strftime("%Y-%m-%d %H:%M:%S")

    await state.update_data(start_date=start_date, end_date=end_date)

    await call.message.answer(f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –ø–µ—Ä–∏–æ–¥: –°–µ–≥–æ–¥–Ω—è ({start_date} - {end_date})")

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º", callback_data="report_sales")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º", callback_data="report_stocks")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º", callback_data="report_incomes")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º", callback_data="report_orders")],
        [InlineKeyboardButton(text="–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º", callback_data="report_reportDetailByPeriod")],
        # [InlineKeyboardButton(text="–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã", callback_data="report_all")]
    ])

    await call.message.answer("–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞:", reply_markup=keyboard)


@router.callback_query(F.data == "period_yesterday")
async def period_yesterday(call: CallbackQuery, state: FSMContext):
    current_time = datetime.now() - timedelta(days=1)

    start_date = current_time.replace(hour=0, minute=0, second=0, microsecond=0).strftime("%Y-%m-%d %H:%M:%S")
    end_date = current_time.replace(hour=23, minute=59, second=59, microsecond=999999).strftime("%Y-%m-%d %H:%M:%S")

    await state.update_data(start_date=start_date, end_date=end_date)

    await call.message.answer(f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –ø–µ—Ä–∏–æ–¥: –í—á–µ—Ä–∞ ({start_date} - {end_date})")

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º", callback_data="report_sales")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º", callback_data="report_stocks")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º", callback_data="report_incomes")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º", callback_data="report_orders")],
        [InlineKeyboardButton(text="–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º", callback_data="report_reportDetailByPeriod")],
        # [InlineKeyboardButton(text="–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã", callback_data="report_all")]
    ])

    await call.message.answer("–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞:", reply_markup=keyboard)


@router.callback_query(F.data == "period_last_7_days")
async def period_last_7_days(call: CallbackQuery, state: FSMContext):
    current_time = datetime.now()

    start_date = (current_time - timedelta(days=7)).strftime("%Y-%m-%d %H:%M:%S")
    end_date = (current_time - timedelta(hours=3)).strftime("%Y-%m-%d %H:%M:%S")

    await state.update_data(start_date=start_date, end_date=end_date)

    await call.message.answer(f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –ø–µ—Ä–∏–æ–¥: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π ({start_date} - {end_date})")

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º", callback_data="report_sales")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º", callback_data="report_stocks")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º", callback_data="report_incomes")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º", callback_data="report_orders")],
        [InlineKeyboardButton(text="–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º", callback_data="report_reportDetailByPeriod")],
        # [InlineKeyboardButton(text="–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã", callback_data="report_all")]
    ])

    await call.message.answer("–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞:", reply_markup=keyboard)

@router.callback_query(F.data == "period_custom")
async def period_custom(call: CallbackQuery, state: FSMContext):
    await call.message.answer("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD HH:MM:SS):")
    await state.set_state("waiting_for_start_date")

@router.message(StateFilter("waiting_for_start_date"))
async def set_start_date(message: types.Message, state: FSMContext):
    start_date = message.text.strip()
    await state.update_data(start_date=start_date)
    await message.answer(f"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {start_date}. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞:")
    await state.set_state("waiting_for_end_date")

@router.message(StateFilter("waiting_for_end_date"))
async def set_end_date(message: Message, state: FSMContext):
    end_date = message.text.strip()
    await state.update_data(end_date=end_date)

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º", callback_data="report_sales")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º", callback_data="report_stocks")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º", callback_data="report_incomes")],
        [InlineKeyboardButton(text="–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º", callback_data="report_orders")],
        [InlineKeyboardButton(text="–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º", callback_data="report_reportDetailByPeriod")],
        # [InlineKeyboardButton(text="–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã", callback_data="report_all")]
    ])

    await message.answer("–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞:", reply_markup=keyboard)
    await state.set_state("waiting_for_report_type")



async def fetch_and_send_report(call, state: FSMContext, report_type: str = None):
    user_data = await state.get_data()
    shop_name = user_data.get("shop_name")
    start_date = user_data.get("start_date")
    end_date = user_data.get("end_date")

    if not start_date or not end_date:
        await call.message.answer("–û—à–∏–±–∫–∞: –ü–µ—Ä–∏–æ–¥ –Ω–µ –∑–∞–¥–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥.")
        return

    api_key = load_api_key_by_shop(shop_name)
    if not api_key:
        await call.message.answer(f"–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω API –∫–ª—é—á –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ '{shop_name}'.")
        return

    endpoint_map = {
        "sales": "https://statistics-api.wildberries.ru/api/v1/supplier",
        "stocks": "https://statistics-api.wildberries.ru/api/v1/supplier",
        "incomes": "https://statistics-api.wildberries.ru/api/v1/supplier",
        "orders": "https://statistics-api.wildberries.ru/api/v1/supplier",
        "reportDetailByPeriod": "https://statistics-api.wildberries.ru/api/v5/supplier",
    }

    endpoint = endpoint_map.get(report_type, endpoint_map["sales"])

    wb_api = WildberriesAPI(api_url=endpoint, api_key=api_key)

    report_data = wb_api.get_sales_data(start_date, end_date) if report_type == "sales" else None
    if report_type == "stocks":
        report_data = wb_api.get_stocks_data(start_date, end_date)
    elif report_type == "incomes":
        report_data = wb_api.get_incomes_data(start_date, end_date)
    elif report_type == "orders":
        report_data = wb_api.get_orders_data(start_date, end_date)
    elif report_type == "reportDetailByPeriod":
        report_data = wb_api.get_reportDetailByPeriod_data(start_date, end_date)

    if report_data:
        if report_type == "sales":
            report = await handle_sales_report(report_data)
        elif report_type == "stocks":
            report = await handle_stocks_report(report_data)
        elif report_type == "incomes":
            report = await handle_incomes_report(report_data)
        elif report_type == "orders":
            report = await handle_orders_report(report_data)
        elif report_type == "reportDetailByPeriod":
            report = await handle_reportDetailByPeriod(report_data)

        await send_report_as_text(call, report)
    else:
        await call.message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.")

async def send_report_as_text(call, report):
    max_length = 4096
    if isinstance(call, CallbackQuery):
        for i in range(0, len(report), max_length):
            await call.message.answer(report[i:i + max_length])
    elif isinstance(call, Message):
        for i in range(0, len(report), max_length):
            await call.answer(report[i:i + max_length])


#/addshop
@router.message(Command("addshop"))
async def add_shop_command(message: Message, state: FSMContext):
    await message.answer("–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:")
    await state.set_state("waiting_for_api_key")

@router.message(StateFilter("waiting_for_api_key"))
async def save_shop_api_key(message: Message, state: FSMContext):
    api_key = message.text.strip()


    wb_api = WildberriesAPI(api_url="https://common-api.wildberries.ru", api_key=api_key)

    response = wb_api.ping()
    if not response:
        await message.answer("–ù–µ–≤–µ—Ä–Ω—ã–π API-–∫–ª—é—á. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞–≥–∞–∑–∏–Ω–∞:")
    await state.update_data(api_key=api_key)
    await state.set_state("waiting_for_shop_name")

def is_duplicate_shop(shop_name: str, api_key: str) -> str:
    with open('config.json', 'r') as f:
        config = json.load(f)

    for shop in config['shops']:
        if shop['name'] == shop_name:
            return f"–ú–∞–≥–∞–∑–∏–Ω —Å –∏–º–µ–Ω–µ–º '{shop_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
        if shop['api_key'] == api_key:
            return f"API-–∫–ª—é—á —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –º–∞–≥–∞–∑–∏–Ω–æ–º."
    return None



@router.message(StateFilter("waiting_for_shop_name"))
async def save_shop_name(message: Message, state: FSMContext):
    shop_name = message.text.strip()
    user_data = await state.get_data()
    api_key = user_data.get("api_key")
    duplicate_message = is_duplicate_shop(shop_name, api_key)
    if duplicate_message:
        await message.answer(duplicate_message)
        await state.clear()
        return
    add_shop(api_key, shop_name)
    await message.answer(f"–ú–∞–≥–∞–∑–∏–Ω '{shop_name}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
    await state.clear()

# –ö–æ–º–∞–Ω–¥–∞ /shops
@router.message(Command("shops"))
async def list_shops_command(message: Message):
    shops = list_shops()
    if not shops:
        await message.answer("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤.")
        return

    shop_list = "\n".join([f"- {shop['name']}" for shop in shops])
    await message.answer(f"–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã:\n{shop_list}")


# –ö–æ–º–∞–Ω–¥–∞ /delshop
@router.message(Command("delshop"))
async def delete_shop_command(message: Message, state: FSMContext):
    shops = list_shops()
    if not shops:
        await message.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–£–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω", callback_data="delete_shop")],
    ])
    inline_buttons = [
        [InlineKeyboardButton(text=shop["name"], callback_data=f"delshop:{shop['name']}")]
        for shop in shops
    ]

    keyboard.inline_keyboard = inline_buttons

    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=keyboard)


@router.callback_query(F.data.startswith("delshop:"))
async def confirm_delete_shop(call: CallbackQuery, state: FSMContext):
    if call.data.startswith("delshop:"):
        shop_name = call.data.split(":")[1]
        delete_shop(shop_name)
        await call.message.answer(f"–ú–∞–≥–∞–∑–∏–Ω '{shop_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.")
        await call.answer()



async def setup_bot_commands(bot: Bot):
    commands = [
        BotCommand(command="start", description="–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º"),
        BotCommand(command="help", description="–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"),
        BotCommand(command="addshop", description="–î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω"),
        BotCommand(command="delshop", description="–£–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω"),
        BotCommand(command="shops", description="–°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤"),
        BotCommand(command="report", description="–ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç"),
    ]
    await bot.set_my_commands(commands)


def load_api_key_by_shop(shop_name: str) -> str:
    try:
        with open('config.json', 'r') as f:
            config = json.load(f)

        for shop in config['shops']:
            if shop['name'] == shop_name:
                return shop['api_key']

        return None

    except FileNotFoundError:
        return None
    except json.JSONDecodeError:
        return None